<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProConnect | Secure Video</title>
    <link rel="icon" href="data:,">
    
    <!-- Fonts: Inter for Professional Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            400: '#60a5fa',
                            500: '#3b82f6', // Corporate Blue
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        slate: {
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a', // Main bg
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; }
        
        /* Professional Glass Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1); /* Subtle border */
        }

        /* Floating Video */
        #local-video-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            touch-action: none;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-[100dvh] flex flex-col overflow-hidden relative selection:bg-brand-500/30">

    <!-- Incoming Call Modal -->
    <div id="incoming-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4">
        <div class="w-full max-w-sm bg-slate-900 border border-slate-700 rounded-xl p-6 flex flex-col items-center gap-6 animate-slide-up shadow-2xl">
            <div class="w-16 h-16 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center animate-pulse-slow">
                <i data-lucide="phone-incoming" class="w-8 h-8 text-brand-500"></i>
            </div>
            <div class="text-center">
                <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Incoming Request</p>
                <h3 id="caller-id-display" class="text-2xl font-bold text-white tracking-tight">Unknown</h3>
                <p class="text-slate-500 text-xs mt-2">Encrypted Video Connection</p>
            </div>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button id="decline-btn" class="flex items-center justify-center gap-2 p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition-all active:scale-95">
                    <span class="text-sm font-semibold">Decline</span>
                </button>
                <button id="accept-btn" class="flex items-center justify-center gap-2 p-4 rounded-lg bg-brand-600 text-white hover:bg-brand-700 shadow-lg shadow-brand-500/20 transition-all active:scale-95">
                    <span class="text-sm font-semibold">Accept</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="px-6 py-4 flex justify-between items-center z-10 bg-slate-950/90 border-b border-slate-800 sticky top-0 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="bg-brand-600 p-1.5 rounded-lg">
                <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-white">Secure<span class="text-brand-500">Call</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <span class="hidden sm:inline text-xs font-medium text-slate-500">END-TO-END ENCRYPTED</span>
            <div id="network-status" class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-sm transition-colors duration-500"></div>
        </div>
    </header>

    <!-- App Container -->
    <main class="flex-grow relative w-full h-full overflow-hidden bg-slate-950">
        <!-- Background decorative mesh -->
        <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden">
            <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-brand-900/10 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-slate-800/20 rounded-full blur-[80px] translate-y-1/2 -translate-x-1/2"></div>
        </div>

        <!-- LOBBY VIEW -->
        <div id="lobby-view" class="relative z-10 w-full h-full flex flex-col p-6 transition-opacity duration-300 overflow-y-auto custom-scrollbar">
            
            <!-- Name Input -->
            <div class="mb-6 max-w-md mx-auto w-full">
                <label class="text-xs font-semibold text-slate-400 mb-2 block ml-1">YOUR IDENTITY</label>
                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="h-4 w-4 text-slate-500"></i>
                        </div>
                        <input id="name-input" type="text" placeholder="Enter display name" 
                            class="w-full bg-slate-900 border border-slate-700 text-white pl-10 pr-4 py-3 rounded-lg focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all placeholder-slate-600 text-sm">
                    </div>
                    <button id="save-name-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 px-6 rounded-lg font-medium text-xs transition-colors">
                        Save
                    </button>
                </div>
            </div>

            <!-- My Number Card -->
            <div class="mb-8 max-w-md mx-auto w-full">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-xl border border-slate-700 shadow-xl relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Your Secure ID</span>
                            <span class="text-[10px] text-brand-500 font-mono mt-0.5">SIP: VOIP-SECURE</span>
                        </div>
                        <i data-lucide="wifi" class="w-4 h-4 text-slate-500"></i>
                    </div>
                    <h2 id="my-id-display" class="text-3xl md:text-4xl font-mono text-white tracking-wider font-medium mb-4">...</h2>
                    
                    <button id="copy-id-btn" class="flex items-center gap-2 text-xs font-medium text-slate-400 hover:text-white transition-colors group-hover:translate-x-1 duration-300">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> 
                        <span>Copy to clipboard</span>
                    </button>
                </div>
            </div>

            <!-- Dial Pad -->
            <div class="pb-8 max-w-md mx-auto w-full">
                <div class="space-y-6">
                    <div>
                        <label class="text-xs font-semibold text-slate-400 mb-2 block ml-1">CONNECT TO</label>
                        <div class="relative">
                            <input id="target-id-input" type="number" pattern="[0-9]*" inputmode="numeric" placeholder="000 000 0000" 
                                class="w-full bg-slate-900 border border-slate-700 text-white text-2xl font-mono text-center py-5 rounded-xl focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all placeholder-slate-700 shadow-inner">
                        </div>
                    </div>

                    <button id="call-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-4 rounded-xl shadow-lg shadow-brand-900/20 active:scale-[0.99] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:grayscale">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                        <span>Initiate Secure Call</span>
                    </button>
                    
                    <p id="status-msg" class="text-center text-xs text-brand-500 h-4 font-medium"></p>
                </div>

                <!-- Recent Connections -->
                <div id="recent-calls-container" class="mt-8 hidden">
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Recent Logs</h3>
                        <span class="text-[10px] text-slate-600 bg-slate-900 px-2 py-0.5 rounded border border-slate-800">HISTORY</span>
                    </div>
                    <div id="recent-calls-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- Javascript will inject items here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CALL VIEW -->
        <div id="call-view" class="hidden absolute inset-0 z-20 bg-slate-950 w-full h-full">
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover opacity-0 transition-opacity duration-1000"></video>
            
            <div id="waiting-overlay" class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm z-30 flex flex-col items-center justify-center">
                <div class="relative">
                    <div class="w-20 h-20 rounded-full border-4 border-slate-800 border-t-brand-500 animate-spin mb-6"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i data-lucide="lock" class="w-6 h-6 text-slate-600"></i>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Establishing Connection</h3>
                <p class="text-slate-400 text-sm font-mono mb-8">Handshake in progress...</p>
                <button id="cancel-call-btn" class="px-8 py-2.5 rounded-full bg-slate-800 border border-slate-700 text-slate-300 hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/50 transition-all text-xs font-bold uppercase tracking-widest">
                    Cancel Request
                </button>
            </div>

            <!-- Local Video -->
            <div id="local-video-container" class="absolute top-6 right-6 w-32 h-48 md:w-48 md:h-72 bg-slate-900 rounded-lg overflow-hidden border border-slate-700 shadow-2xl z-40 cursor-move">
                <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
                <div class="absolute bottom-2 left-2 flex items-center gap-1 bg-black/50 backdrop-blur px-1.5 py-0.5 rounded text-[10px] text-white font-medium">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span>You</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-8 left-0 right-0 flex justify-center items-center gap-6 z-40 px-6">
                <button id="mute-btn" class="w-14 h-14 rounded-full bg-slate-900/80 backdrop-blur border border-slate-700 text-slate-300 flex items-center justify-center hover:bg-slate-800 hover:text-white transition-all">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                <button id="hangup-btn" class="w-16 h-16 rounded-full bg-red-600 shadow-xl shadow-red-900/40 text-white flex items-center justify-center hover:bg-red-700 transition-all active:scale-95">
                    <i data-lucide="phone-off" class="w-7 h-7 fill-current"></i>
                </button>
                <button id="camera-btn" class="w-14 h-14 rounded-full bg-slate-900/80 backdrop-blur border border-slate-700 text-slate-300 flex items-center justify-center hover:bg-slate-800 hover:text-white transition-all">
                    <i data-lucide="video" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SOUND MANAGER (Web Audio API) ---
        const sm = {
            ctx: null,
            timer: null,
            
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playRingtone: function() { // Incoming
                this.stop(); 
                this.init();
                const playBeeps = () => {
                    const t = this.ctx.currentTime;
                    // Dual tone trill
                    const o1 = this.ctx.createOscillator();
                    const o2 = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    
                    o1.type = 'sine'; o2.type = 'triangle';
                    o1.frequency.setValueAtTime(600, t);
                    o1.frequency.exponentialRampToValueAtTime(800, t + 0.1);
                    o2.frequency.setValueAtTime(605, t);
                    o2.frequency.exponentialRampToValueAtTime(805, t + 0.1);

                    g.gain.setValueAtTime(0.15, t);
                    g.gain.linearRampToValueAtTime(0, t + 0.6);

                    o1.connect(g); o2.connect(g);
                    g.connect(this.ctx.destination);
                    o1.start(t); o2.start(t);
                    o1.stop(t + 0.6); o2.stop(t + 0.6);
                };
                playBeeps();
                this.timer = setInterval(playBeeps, 2000);
            },

            playRingback: function() { // Outgoing
                this.stop();
                this.init();
                const playTone = () => {
                    const t = this.ctx.currentTime;
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.frequency.value = 400; // Low hum
                    o.type = 'sine';
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.linearRampToValueAtTime(0.1, t + 1.5);
                    g.gain.linearRampToValueAtTime(0, t + 1.6);
                    o.connect(g); g.connect(this.ctx.destination);
                    o.start(t); o.stop(t + 1.6);
                };
                playTone();
                this.timer = setInterval(playTone, 3000);
            },

            playConnect: function() {
                this.stop();
                this.init();
                const t = this.ctx.currentTime;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.frequency.setValueAtTime(400, t);
                o.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t + 0.3);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(t); o.stop(t + 0.3);
            },

            playEnd: function() {
                this.stop();
                this.init();
                const t = this.ctx.currentTime;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.frequency.setValueAtTime(300, t);
                o.frequency.linearRampToValueAtTime(100, t + 0.2);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t + 0.2);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(t); o.stop(t + 0.2);
            },

            stop: function() {
                if (this.timer) { clearInterval(this.timer); this.timer = null; }
            }
        };

        // --- CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                 firebaseConfig = {
                  apiKey: "AIzaSyCVll5mX9iLagImGhSuR7et1LamL0SxK9s",
                  authDomain: "video-calling-214be.firebaseapp.com",
                  projectId: "video-calling-214be",
                  storageBucket: "video-calling-214be.firebasestorage.app",
                  messagingSenderId: "760562664424",
                  appId: "1:760562664424:web:be0361c94619f00421da5d",
                  measurementId: "G-3CZ0BG0K47"
                };
            }
        } catch (e) { console.error("Config Error:", e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let myId = localStorage.getItem('lux_user_id');
        let myName = localStorage.getItem('lux_user_name') || ""; 

        if (!myId || myId.length !== 10) {
            myId = Math.floor(1000000000 + Math.random() * 9000000000).toString();
            localStorage.setItem('lux_user_id', myId);
        }

        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let currentCallId = null; 
        let isCaller = false;
        let unsubscribeActiveCall = null;
        let unsubscribeIncoming = null;
        let processedCandidates = new Set();

        // --- UI ---
        const getEl = (id) => document.getElementById(id);
        const ui = {
            lobby: getEl('lobby-view'),
            call: getEl('call-view'),
            myIdDisplay: getEl('my-id-display'),
            targetInput: getEl('target-id-input'),
            callBtn: getEl('call-btn'),
            status: getEl('status-msg'),
            localVideo: getEl('local-video'),
            remoteVideo: getEl('remote-video'),
            localVideoContainer: getEl('local-video-container'), 
            waitingOverlay: getEl('waiting-overlay'),
            incomingModal: getEl('incoming-modal'),
            callerIdDisplay: getEl('caller-id-display'),
            acceptBtn: getEl('accept-btn'),
            declineBtn: getEl('decline-btn'),
            cancelBtn: getEl('cancel-call-btn'),
            hangupBtn: getEl('hangup-btn'),
            muteBtn: getEl('mute-btn'),
            cameraBtn: getEl('camera-btn'),
            networkStatus: getEl('network-status'),
            copyIdBtn: getEl('copy-id-btn'),
            nameInput: getEl('name-input'),
            saveNameBtn: getEl('save-name-btn'),
            recentCallsList: getEl('recent-calls-list'),
            recentCallsContainer: getEl('recent-calls-container')
        };

        // --- RECENTS ---
        function loadRecents() {
            try { return JSON.parse(localStorage.getItem('lux_recents') || '[]'); } catch { return []; }
        }

        function saveRecent(id, name, type) {
            if(!id) return;
            const recents = loadRecents();
            const existingIndex = recents.findIndex(r => r.id === id);
            
            let displayName = name;
            // Preserve existing name if new one is unknown
            if(existingIndex !== -1) {
                if((!name || name === 'Unknown') && recents[existingIndex].name !== 'Unknown') {
                    displayName = recents[existingIndex].name;
                }
                recents.splice(existingIndex, 1);
            }

            recents.unshift({
                id: id,
                name: displayName || "Unknown",
                lastContact: Date.now(),
                type: type // 'incoming', 'outgoing', 'missed'
            });

            if(recents.length > 20) recents.pop(); // Store 20
            localStorage.setItem('lux_recents', JSON.stringify(recents));
            renderRecents();
        }

        function renderRecents() {
            const recents = loadRecents();
            if(recents.length === 0) {
                ui.recentCallsContainer.classList.add('hidden');
                return;
            }
            
            ui.recentCallsContainer.classList.remove('hidden');
            ui.recentCallsList.innerHTML = '';
            
            recents.forEach(contact => {
                const item = document.createElement('div');
                item.className = "bg-slate-900 border border-slate-800 p-3 rounded-lg flex justify-between items-center group hover:border-brand-500/30 transition-all";
                
                const formattedId = contact.id.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
                const isUnknown = contact.name === 'Unknown';
                let typeIcon = '';
                let typeColor = '';

                if (contact.type === 'missed') {
                    typeIcon = '<i data-lucide="phone-missed" class="w-3 h-3"></i>';
                    typeColor = 'text-red-500 font-bold';
                } else if (contact.type === 'incoming') {
                    typeIcon = '<i data-lucide="arrow-down-left" class="w-3 h-3"></i>';
                    typeColor = 'text-blue-400';
                } else {
                    typeIcon = '<i data-lucide="arrow-up-right" class="w-3 h-3"></i>';
                    typeColor = 'text-green-500';
                }
                
                item.innerHTML = `
                    <div class="cursor-pointer flex-grow" onclick="window.populateAndCall('${contact.id}')">
                        <p class="text-slate-200 font-medium text-sm ${isUnknown ? 'italic text-slate-500' : ''}">${contact.name}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-xs ${typeColor} flex items-center gap-1">
                                ${typeIcon} ${contact.type === 'missed' ? 'Missed' : ''}
                            </span>
                            <p class="text-xs text-slate-500 font-mono tracking-wider">${formattedId}</p>
                        </div>
                    </div>
                    <button onclick="window.populateAndCall('${contact.id}')" class="text-slate-400 p-2 rounded-full hover:bg-brand-600 hover:text-white transition-colors">
                        <i data-lucide="phone" class="w-4 h-4"></i>
                    </button>
                `;
                ui.recentCallsList.appendChild(item);
            });
            lucide.createIcons();
        }
        
        window.populateAndCall = (id) => {
            if(ui.targetInput) {
                ui.targetInput.value = id;
                ui.callBtn.click();
            }
        };

        // --- DRAGGABLE ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;
            element.ontouchstart = dragTouchStart;
            function dragMouseDown(e) { e=e||window.event; e.preventDefault(); pos3=e.clientX; pos4=e.clientY; document.onmouseup=closeDragElement; document.onmousemove=elementDrag; }
            function dragTouchStart(e) { const touch=e.touches[0]; pos3=touch.clientX; pos4=touch.clientY; document.ontouchend=closeDragElement; document.ontouchmove=elementDragTouch; }
            function elementDrag(e) { e=e||window.event; e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; setElementPos(); }
            function elementDragTouch(e) { const touch=e.touches[0]; pos1=pos3-touch.clientX; pos2=pos4-touch.clientY; pos3=touch.clientX; pos4=touch.clientY; setElementPos(); }
            function setElementPos() {
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight;
                if(newTop < 0) newTop = 0; if(newLeft < 0) newLeft = 0; if(newTop > maxY) newTop = maxY; if(newLeft > maxX) newLeft = maxX;
                element.style.top = newTop + "px"; element.style.left = newLeft + "px"; element.style.right = 'auto'; element.style.bottom = 'auto';
            }
            function closeDragElement() { document.onmouseup=null; document.onmousemove=null; document.ontouchend=null; document.ontouchmove=null; }
        }
        if(ui.localVideoContainer) makeDraggable(ui.localVideoContainer);

        // --- INITIALIZATION ---
        if (ui.myIdDisplay) ui.myIdDisplay.textContent = myId.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
        if (ui.nameInput && myName) ui.nameInput.value = myName;
        renderRecents();
        lucide.createIcons();

        // --- AUTH ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error", error);
                if(ui.status) ui.status.textContent = "Auth Error. Refresh.";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if(ui.networkStatus) {
                    ui.networkStatus.classList.remove('bg-red-500');
                    ui.networkStatus.classList.add('bg-green-500', 'shadow-[0_0_8px_rgba(34,197,94,0.5)]');
                }
                if(ui.callBtn) ui.callBtn.disabled = false;
                
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', myId);
                getDoc(userDocRef).then(snap => {
                    if(snap.exists() && snap.data().name) {
                        myName = snap.data().name;
                        if(ui.nameInput) ui.nameInput.value = myName;
                        localStorage.setItem('lux_user_name', myName);
                    }
                });

                listenForIncomingCalls(); 
            }
        });
        initAuth();

        // --- SAVE NAME ---
        if(ui.saveNameBtn) {
            ui.saveNameBtn.onclick = async () => {
                const name = ui.nameInput.value.trim();
                if(!name) { ui.status.textContent = "Please enter a name"; return; }
                ui.saveNameBtn.disabled = true; ui.saveNameBtn.textContent = "...";
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', myId), { name: name }, { merge: true });
                    myName = name; localStorage.setItem('lux_user_name', name);
                    ui.saveNameBtn.textContent = "Saved";
                    setTimeout(() => { ui.saveNameBtn.disabled = false; ui.saveNameBtn.textContent = "Save"; }, 2000);
                } catch(e) { console.error(e); ui.saveNameBtn.disabled = false; ui.saveNameBtn.textContent = "Save"; }
            };
        }

        // --- WEBRTC ---
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }], iceCandidatePoolSize: 10 };

        async function startLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                if(ui.localVideo) ui.localVideo.srcObject = stream;
                
                // Opacity transition for smooth video loading
                if(ui.remoteVideo) ui.remoteVideo.classList.remove('opacity-0');
                
                remoteStream = new MediaStream();
                if(ui.remoteVideo) ui.remoteVideo.srcObject = remoteStream;
                return true;
            } catch (err) {
                console.error(err);
                if(ui.status) ui.status.textContent = "Error: Camera/Mic required";
                return false;
            }
        }

        function createPeerConnection(isInitiator, callDocRef) {
            pc = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            pc.onicecandidate = event => {
                if (event.candidate) {
                    const fieldName = isInitiator ? 'offerCandidates' : 'answerCandidates';
                    updateDoc(callDocRef, { [fieldName]: arrayUnion(event.candidate.toJSON()) }).catch(e => {});
                }
            };
            return pc;
        }

        // --- LOGIC: LISTEN ---
        function listenForIncomingCalls() {
            const myCallDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);

            unsubscribeIncoming = onSnapshot(myCallDoc, (snapshot) => {
                const data = snapshot.data();
                if(!data) return;

                // 1. Check for Missed Calls (from DB)
                if (data.missed && Array.isArray(data.missed) && data.missed.length > 0) {
                    data.missed.forEach(call => {
                        saveRecent(call.callerId, call.callerName || "Unknown", 'missed');
                    });
                    updateDoc(myCallDoc, { missed: [] });
                }

                // 2. Incoming Call
                if (data.status === 'calling' && !currentCallId) {
                    const callerName = data.callerName || data.callerId || "Unknown";
                    if(ui.callerIdDisplay) ui.callerIdDisplay.textContent = callerName;
                    if(ui.incomingModal) {
                        ui.incomingModal.classList.remove('hidden');
                        ui.incomingModal.classList.add('flex');
                        sm.playRingtone(); // PLAY RINGTONE
                    }
                    saveRecent(data.callerId, data.callerName || "Unknown", 'incoming');
                }
                
                // 3. Call Ended Remotely
                if (data.status === 'ended' && currentCallId && !isCaller) {
                   resetCall();
                }
            }, (error) => console.warn("Incoming listener warning:", error));
        }

        // --- LOGIC: CALL ---
        if(ui.callBtn) {
            ui.callBtn.onclick = async () => {
                const targetId = ui.targetInput.value.replace(/\s/g, '');
                if (targetId.length !== 10) return ui.status.textContent = "Enter 10-digit ID";
                if (targetId === myId) return ui.status.textContent = "Cannot call self";
                ui.callBtn.disabled = true; ui.status.textContent = "Dialing...";

                let targetName = "Unknown";
                try {
                     const targetUserDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId));
                     if(targetUserDoc.exists() && targetUserDoc.data().name) targetName = targetUserDoc.data().name;
                } catch(e) {}
                saveRecent(targetId, targetName, 'outgoing');

                if (await startLocalStream()) {
                    isCaller = true; currentCallId = targetId; processedCandidates.clear();
                    ui.lobby.classList.add('hidden'); ui.call.classList.remove('hidden'); ui.waitingOverlay.classList.remove('hidden');
                    
                    sm.playRingback(); // PLAY RINGBACK

                    const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', targetId);
                    pc = createPeerConnection(true, callDocRef);
                    const offerDescription = await pc.createOffer();
                    await pc.setLocalDescription(offerDescription);
                    const offer = { sdp: offerDescription.sdp, type: offerDescription.type };

                    try {
                        await setDoc(callDocRef, {
                            callerId: myId,
                            callerName: myName || "Unknown",
                            offer: offer,
                            status: 'calling',
                            timestamp: Date.now(),
                            offerCandidates: [],
                            answerCandidates: [],
                        }, { merge: true });
                    } catch (e) {
                        console.error("SetDoc failed", e); ui.status.textContent = "Connection Error"; resetCall(); return;
                    }

                    unsubscribeActiveCall = onSnapshot(callDocRef, (snapshot) => {
                        const data = snapshot.data();
                        if (!data) { resetCall(); return; }
                        
                        if (pc && pc.signalingState === 'have-local-offer' && data.answer && data.status === 'connected') {
                            const answerDescription = new RTCSessionDescription(data.answer);
                            pc.setRemoteDescription(answerDescription)
                                .then(() => {
                                    ui.waitingOverlay.classList.add('hidden');
                                    sm.playConnect(); // PLAY CONNECT SOUND
                                })
                                .catch(e => console.error("Error answer:", e));
                        }

                        if (data.answerCandidates && Array.isArray(data.answerCandidates)) {
                            data.answerCandidates.forEach(candidate => {
                                const candStr = JSON.stringify(candidate);
                                if (!processedCandidates.has(candStr)) {
                                    processedCandidates.add(candStr);
                                    if(pc && pc.remoteDescription) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(e=>{});
                                }
                            });
                        }

                        if (data.status === 'ended') resetCall();
                    });
                }
            };
        }

        // --- LOGIC: ACCEPT ---
        if(ui.acceptBtn) {
            ui.acceptBtn.onclick = async () => {
                ui.incomingModal.classList.add('hidden'); ui.incomingModal.classList.remove('flex');
                
                sm.playConnect(); // PLAY CONNECT SOUND

                if (await startLocalStream()) {
                    isCaller = false; currentCallId = myId; processedCandidates.clear();
                    ui.lobby.classList.add('hidden'); ui.call.classList.remove('hidden'); ui.waitingOverlay.classList.add('hidden');

                    const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);
                    pc = createPeerConnection(false, callDocRef);
                    const snapshot = await getDoc(callDocRef);
                    const data = snapshot.data();
                    if(!data) { resetCall(); return; }
                    
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answerDescription = await pc.createAnswer();
                    await pc.setLocalDescription(answerDescription);
                    const answer = { type: answerDescription.type, sdp: answerDescription.sdp };

                    await updateDoc(callDocRef, { answer: answer, status: 'connected' });

                    if(data.offerCandidates) {
                        data.offerCandidates.forEach(c => {
                            const str = JSON.stringify(c);
                            if(!processedCandidates.has(str)) { processedCandidates.add(str); pc.addIceCandidate(new RTCIceCandidate(c)); }
                        });
                    }

                    unsubscribeActiveCall = onSnapshot(callDocRef, (snapshot) => {
                        const data = snapshot.data();
                        if (!data) return;
                        if (data.offerCandidates && Array.isArray(data.offerCandidates)) {
                            data.offerCandidates.forEach(candidate => {
                                const candStr = JSON.stringify(candidate);
                                if (!processedCandidates.has(candStr)) {
                                    processedCandidates.add(candStr);
                                    if(pc && pc.remoteDescription) pc.addIceCandidate(new RTCIceCandidate(candidate));
                                }
                            });
                        }
                    });
                }
            };
        }

        // --- UTILS ---
        
        async function cancelCall() {
            if (currentCallId && isCaller) {
                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId);
                try {
                    await updateDoc(callDoc, {
                        status: 'ended',
                        offer: deleteField(),
                        missed: arrayUnion({
                            callerId: myId,
                            callerName: myName || "Unknown",
                            timestamp: Date.now()
                        })
                    });
                } catch(e) {}
            }
            resetCall();
        }

        async function endConnectedCall() {
             if (currentCallId) {
                const docId = isCaller ? currentCallId : myId;
                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', docId);
                try {
                    await updateDoc(callDoc, { status: 'ended' }); 
                } catch(e) {}
            }
            resetCall();
        }

        function resetCall() {
            sm.stop(); // STOP SOUNDS
            
            if(currentCallId) {
                sm.playEnd(); // PLAY END TONE
            }

            if (pc) { pc.close(); pc = null; }
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if (unsubscribeActiveCall) { unsubscribeActiveCall(); unsubscribeActiveCall = null; }
            ui.incomingModal.classList.add('hidden'); ui.incomingModal.classList.remove('flex');
            ui.call.classList.add('hidden'); ui.lobby.classList.remove('hidden'); ui.lobby.classList.remove('opacity-0');
            ui.callBtn.disabled = false; ui.status.textContent = ""; currentCallId = null;
            if(ui.remoteVideo) ui.remoteVideo.classList.add('opacity-0');
        }

        if(ui.declineBtn) {
            ui.declineBtn.onclick = async () => {
                 ui.incomingModal.classList.add('hidden'); ui.incomingModal.classList.remove('flex');
                 sm.stop(); // STOP RINGING
                 const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);
                 try { await updateDoc(callDoc, { status: 'ended' }); } catch(e) {}
            };
        }

        if(ui.cancelBtn) ui.cancelBtn.onclick = cancelCall; 
        if(ui.hangupBtn) ui.hangupBtn.onclick = endConnectedCall;

        if(ui.muteBtn) {
            ui.muteBtn.onclick = () => {
                if(localStream) {
                    const track = localStream.getAudioTracks()[0];
                    if(track) { track.enabled = !track.enabled; ui.muteBtn.innerHTML = track.enabled ? '<i data-lucide="mic" class="w-6 h-6"></i>' : '<i data-lucide="mic-off" class="w-6 h-6 text-red-500"></i>'; lucide.createIcons(); }
                }
            };
        }
        if(ui.cameraBtn) {
            ui.cameraBtn.onclick = () => {
                if(localStream) {
                    const track = localStream.getVideoTracks()[0];
                    if(track) { track.enabled = !track.enabled; ui.cameraBtn.innerHTML = track.enabled ? '<i data-lucide="video" class="w-6 h-6"></i>' : '<i data-lucide="video-off" class="w-6 h-6 text-red-500"></i>'; lucide.createIcons(); }
                }
            };
        }
        if (ui.copyIdBtn) {
             ui.copyIdBtn.onclick = () => {
                 navigator.clipboard.writeText(myId).then(() => {
                     const original = ui.copyIdBtn.innerHTML;
                     // Only update text node, preserve icon
                     const textSpan = ui.copyIdBtn.querySelector('span');
                     if(textSpan) textSpan.textContent = "Copied!";
                     setTimeout(() => { if(textSpan) textSpan.textContent = "Copy to clipboard"; }, 1500);
                 });
            }
        }
    </script>
</body>
</html>
