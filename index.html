<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurum | Premium Video Experience</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Luxury Styles -->
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F1E5AC;
            --gold-dark: #AA8C2C;
            --black: #050505;
            --charcoal: #121212;
            --glass: rgba(18, 18, 18, 0.85);
        }

        body {
            background-color: var(--black);
            color: var(--gold-light);
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(212, 175, 55, 0.05) 0%, transparent 20%);
        }

        h1, h2, h3, .brand-font {
            font-family: 'Cinzel', serif;
        }

        /* Gold Gradient Text */
        .text-gold-gradient {
            background: linear-gradient(to right, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 5s linear infinite;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        /* Luxury Button */
        .btn-luxury {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-luxury:hover {
            background: var(--gold);
            color: var(--black);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        }

        .btn-luxury::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg) translate(-100%, -100%);
            transition: transform 0.6s;
        }

        .btn-luxury:hover::after {
            transform: rotate(45deg) translate(0, 0);
        }

        /* Inputs */
        .input-luxury {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--gold-light);
            transition: all 0.3s;
        }
        
        .input-luxury:focus {
            border-color: var(--gold);
            outline: none;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
        }

        /* Glass Panel */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Video Container */
        .video-wrapper {
            position: relative;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8);
        }

        .video-wrapper.remote {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.4);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--gold);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Navbar -->
    <nav class="absolute top-0 w-full p-6 flex justify-between items-center z-50">
        <div class="flex items-center gap-2">
            <i data-lucide="crown" class="text-yellow-600 w-6 h-6"></i>
            <span class="text-2xl tracking-widest brand-font font-bold text-gold-gradient">AURUM</span>
        </div>
        <div class="text-xs text-yellow-100/50 tracking-widest uppercase">Encrypted & Anonymous</div>
    </nav>

    <!-- SECTION: LANDING / AUTH -->
    <div id="landing-section" class="text-center space-y-8 max-w-lg w-full z-10">
        <div class="space-y-4">
            <h1 class="text-5xl md:text-6xl font-bold leading-tight">
                Connect in <br>
                <span class="text-gold-gradient">Absolute Luxury</span>
            </h1>
            <p class="text-yellow-100/60 font-light text-lg">Premium video signaling. Zero logs. Infinite elegance.</p>
        </div>
        
        <button id="signInBtn" class="btn-luxury px-10 py-4 text-sm tracking-widest uppercase font-bold rounded-sm w-full md:w-auto">
            Enter Experience
        </button>
        
        <div id="authLoader" class="hidden flex justify-center mt-4">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- SECTION: LOBBY -->
    <div id="lobby-section" class="hidden w-full max-w-4xl z-10 flex flex-col md:flex-row gap-8 items-stretch">
        
        <!-- Create Room Card -->
        <div class="glass-panel p-8 flex-1 rounded-sm flex flex-col items-center justify-center text-center space-y-6">
            <div class="bg-yellow-900/20 p-4 rounded-full">
                <i data-lucide="video" class="text-yellow-500 w-8 h-8"></i>
            </div>
            <div>
                <h3 class="text-2xl mb-2 text-white">Start a Call</h3>
                <p class="text-sm text-white/50">Create a secure room and share the key.</p>
            </div>
            <button id="createRoomBtn" class="btn-luxury px-8 py-3 text-xs tracking-widest uppercase w-full">
                Create Room
            </button>
        </div>

        <div class="flex items-center justify-center">
            <div class="w-px h-full bg-gradient-to-b from-transparent via-yellow-700/50 to-transparent hidden md:block"></div>
            <div class="h-px w-full bg-gradient-to-r from-transparent via-yellow-700/50 to-transparent block md:hidden"></div>
        </div>

        <!-- Join Room Card -->
        <div class="glass-panel p-8 flex-1 rounded-sm flex flex-col items-center justify-center text-center space-y-6">
            <div class="bg-yellow-900/20 p-4 rounded-full">
                <i data-lucide="users" class="text-yellow-500 w-8 h-8"></i>
            </div>
            <div>
                <h3 class="text-2xl mb-2 text-white">Join a Call</h3>
                <p class="text-sm text-white/50">Enter an existing room key below.</p>
            </div>
            <input type="text" id="roomInput" placeholder="Enter Room Key..." class="input-luxury w-full p-3 text-center text-sm tracking-wide rounded-sm bg-transparent">
            <button id="joinRoomBtn" class="btn-luxury px-8 py-3 text-xs tracking-widest uppercase w-full">
                Join Room
            </button>
        </div>
    </div>

    <!-- SECTION: VIDEO ROOM -->
    <div id="room-section" class="hidden fixed inset-0 bg-black z-40 flex flex-col">
        
        <!-- Header -->
        <div class="absolute top-0 left-0 right-0 p-6 flex justify-between items-center z-50 bg-gradient-to-b from-black/80 to-transparent">
            <div class="flex items-center gap-3">
                <span class="text-xs text-yellow-500 uppercase tracking-widest">Room Key:</span>
                <span id="currentRoomId" class="font-mono text-white text-sm bg-white/10 px-2 py-1 rounded cursor-pointer hover:bg-white/20 transition">...</span>
            </div>
            <button id="hangupBtn" class="bg-red-900/80 hover:bg-red-700 text-red-100 px-4 py-2 rounded-sm text-xs uppercase tracking-widest border border-red-500/30 transition">
                End Call
            </button>
        </div>

        <!-- Video Grid -->
        <div class="flex-1 relative flex items-center justify-center p-4 md:p-10">
            
            <!-- Remote Video (Main) -->
            <div class="video-wrapper remote w-full h-full max-w-6xl max-h-screen relative bg-zinc-900">
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <div id="remoteStatus" class="absolute inset-0 flex items-center justify-center text-white/30 text-sm tracking-widest uppercase animate-pulse">
                    Waiting for guest...
                </div>
            </div>

            <!-- Local Video (Picture in Picture) -->
            <div class="absolute bottom-8 right-8 w-32 md:w-64 aspect-video video-wrapper z-50 shadow-2xl hover:scale-105 transition duration-300">
                <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
                <div class="absolute bottom-2 left-2 flex gap-1">
                     <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-4 p-4 rounded-full glass-panel z-50">
            <button id="toggleMic" class="p-3 rounded-full hover:bg-white/10 text-yellow-500 transition border border-transparent hover:border-yellow-500/30">
                <i data-lucide="mic" class="w-5 h-5"></i>
            </button>
            <button id="toggleCam" class="p-3 rounded-full hover:bg-white/10 text-yellow-500 transition border border-transparent hover:border-yellow-500/30">
                <i data-lucide="camera" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-white/10 backdrop-blur-md border border-yellow-500/20 text-yellow-100 px-6 py-3 rounded-sm text-sm tracking-wide opacity-0 pointer-events-none transition duration-300 z-[100]">
        Notification
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, addDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVll5mX9iLagImGhSuR7et1LamL0SxK9s",
            authDomain: "video-calling-214be.firebaseapp.com",
            projectId: "video-calling-214be",
            storageBucket: "video-calling-214be.firebasestorage.app",
            messagingSenderId: "760562664424",
            appId: "1:760562664424:web:be0361c94619f00421da5d",
            measurementId: "G-3CZ0BG0K47"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- WebRTC Config ---
        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
            iceCandidatePoolSize: 10,
        };

        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let roomId = null;

        // --- DOM Elements ---
        const landingSection = document.getElementById('landing-section');
        const lobbySection = document.getElementById('lobby-section');
        const roomSection = document.getElementById('room-section');
        const authLoader = document.getElementById('authLoader');
        const signInBtn = document.getElementById('signInBtn');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomInput = document.getElementById('roomInput');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const hangupBtn = document.getElementById('hangupBtn');
        const currentRoomIdDisplay = document.getElementById('currentRoomId');
        const remoteStatus = document.getElementById('remoteStatus');

        // --- Icons ---
        lucide.createIcons();

        // --- State Management ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        function switchView(view) {
            landingSection.classList.add('hidden');
            lobbySection.classList.add('hidden');
            roomSection.classList.add('hidden');
            
            if (view === 'landing') landingSection.classList.remove('hidden');
            if (view === 'lobby') lobbySection.classList.remove('hidden');
            if (view === 'room') roomSection.classList.remove('hidden');
        }

        // --- Authentication ---
        signInBtn.onclick = () => {
            signInBtn.classList.add('hidden');
            authLoader.classList.remove('hidden');
            signInAnonymously(auth).catch((error) => {
                console.error("Auth Failed", error);
                signInBtn.classList.remove('hidden');
                authLoader.classList.add('hidden');
                showToast("Authentication failed. Check console.");
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User signed in:", user.uid);
                authLoader.classList.add('hidden');
                switchView('lobby');
            } else {
                switchView('landing');
            }
        });

        // --- WebRTC Implementation ---

        // 1. Setup Media & Connection
        async function openUserMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                remoteStream = new MediaStream();
                remoteVideo.srcObject = remoteStream;
            } catch (err) {
                console.error("Error accessing media devices.", err);
                showToast("Camera access denied.");
            }
        }

        // 2. Create Room (Caller)
        createRoomBtn.onclick = async () => {
            createRoomBtn.disabled = true;
            createRoomBtn.innerText = "Creating...";
            
            await openUserMedia();
            
            pc = new RTCPeerConnection(servers);

            // Push tracks
            localStream.getTracks().forEach((track) => {
                pc.addTrack(track, localStream);
            });

            // Pull tracks
            pc.ontrack = (event) => {
                event.streams[0].getTracks().forEach((track) => {
                    remoteStream.addTrack(track);
                });
                remoteStatus.classList.add('hidden');
            };

            // Setup Firestore Doc
            // Note: Using a specific path structure for stability
            // Using a timestamp + random string for Room ID
            const newRoomId = Math.random().toString(36).substring(2, 9);
            roomId = newRoomId;
            
            // Path: artifacts/video-chat/public/data/calls (Environment compliant path)
            // Or simpler root path since we use user's config.
            // We'll use a root collection 'calls' as per user config permissions assumption.
            const callDocRef = doc(db, 'calls', roomId);
            
            // Collect ICE candidates
            const callerCandidates = [];
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    // Update array locally then push
                    // In a real app we'd use arrayUnion on the doc
                    // Here we defer until the doc is created or update it live
                    // Simpler: Just save valid candidates to a sub-property
                    // However, we need to write them to DB
                    updateDoc(callDocRef, {
                        callerCandidates: arrayUnion(event.candidate.toJSON())
                    }).catch(e => console.log("Error adding candidate", e));
                }
            };

            // Create Offer
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            const callData = {
                offer: {
                    type: offerDescription.type,
                    sdp: offerDescription.sdp,
                },
                callerCandidates: [],
                calleeCandidates: [],
                date: new Date().toISOString()
            };

            await setDoc(callDocRef, callData);

            currentRoomIdDisplay.innerText = roomId;
            switchView('room');
            showToast("Room created! Click ID to copy.");

            // Listen for Answer
            onSnapshot(callDocRef, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answerDescription);
                }
                
                // Add Callee Candidates (Remote) to PC
                if (data?.calleeCandidates) {
                    data.calleeCandidates.forEach((candidate) => {
                        const candidateObj = new RTCIceCandidate(candidate);
                        pc.addIceCandidate(candidateObj).catch(e => console.error("Error adding ice", e));
                    });
                }
            });
        };

        // 3. Join Room (Callee)
        joinRoomBtn.onclick = async () => {
            roomId = roomInput.value.trim();
            if(!roomId) {
                showToast("Please enter a Room Key");
                return;
            }

            joinRoomBtn.disabled = true;
            joinRoomBtn.innerText = "Joining...";

            const callDocRef = doc(db, 'calls', roomId);
            const callDoc = await getDoc(callDocRef);

            if (!callDoc.exists()) {
                showToast("Room does not exist.");
                joinRoomBtn.disabled = false;
                joinRoomBtn.innerText = "Join Room";
                return;
            }

            await openUserMedia();
            pc = new RTCPeerConnection(servers);

            // Push tracks
            localStream.getTracks().forEach((track) => {
                pc.addTrack(track, localStream);
            });

            // Pull tracks
            pc.ontrack = (event) => {
                event.streams[0].getTracks().forEach((track) => {
                    remoteStream.addTrack(track);
                });
                remoteStatus.classList.add('hidden');
            };

            // ICE Candidates for Callee
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    updateDoc(callDocRef, {
                        calleeCandidates: arrayUnion(event.candidate.toJSON())
                    });
                }
            };

            // Process Offer
            const offerDescription = callDoc.data().offer;
            await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

            // Create Answer
            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const answer = {
                type: answerDescription.type,
                sdp: answerDescription.sdp,
            };

            await updateDoc(callDocRef, { answer });

            currentRoomIdDisplay.innerText = roomId;
            switchView('room');

            // Listen for Remote Candidates (Caller's)
            onSnapshot(callDocRef, (snapshot) => {
                const data = snapshot.data();
                if (data?.callerCandidates) {
                    data.callerCandidates.forEach((candidate) => {
                        const candidateObj = new RTCIceCandidate(candidate);
                        pc.addIceCandidate(candidateObj).catch(e => console.error("Error adding ice", e));
                    });
                }
            });
        };

        // --- Controls & Utilities ---
        
        currentRoomIdDisplay.onclick = () => {
            navigator.clipboard.writeText(roomId);
            showToast("Room Key copied to clipboard");
        };

        hangupBtn.onclick = () => {
            // Close tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (pc) {
                pc.close();
            }
            // Reset UI
            roomId = null;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            location.reload(); // Simple reload to reset state cleanly
        };

        // Media Toggles
        document.getElementById('toggleMic').onclick = (e) => {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                e.currentTarget.innerHTML = audioTrack.enabled 
                    ? `<i data-lucide="mic" class="w-5 h-5"></i>`
                    : `<i data-lucide="mic-off" class="w-5 h-5 text-red-500"></i>`;
                lucide.createIcons();
            }
        };

        document.getElementById('toggleCam').onclick = (e) => {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                e.currentTarget.innerHTML = videoTrack.enabled 
                    ? `<i data-lucide="camera" class="w-5 h-5"></i>`
                    : `<i data-lucide="camera-off" class="w-5 h-5 text-red-500"></i>`;
                lucide.createIcons();
            }
        };

    </script>
</body>
</html>
