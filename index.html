<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuxCall | Premium Mobile</title>
    <link rel="icon" href="data:,">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            100: '#F9F1D8',
                            300: '#E6C87C',
                            400: '#D4AF37',
                            500: '#C5A028',
                            600: '#997B19',
                        },
                        rich: {
                            900: '#0a0a0a',
                            800: '#121212',
                            700: '#1a1a1a',
                            600: '#2a2a2a'
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'ring': 'ring 1.5s infinite'
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        ring: {
                            '0%': { transform: 'rotate(0deg)' },
                            '10%': { transform: 'rotate(10deg)' },
                            '20%': { transform: 'rotate(-10deg)' },
                            '30%': { transform: 'rotate(5deg)' },
                            '40%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(0deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; }
        
        /* Glassmorphism */
        .glass-panel {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        /* Floating Video */
        #local-video-container {
            /* Removed transition for smooth dragging */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            touch-action: none; /* Crucial for dragging on mobile */
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Scrollbar for lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1); 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #D4AF37; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-rich-900 text-gray-200 font-sans h-[100dvh] flex flex-col overflow-hidden relative">

    <!-- Incoming Call Modal -->
    <div id="incoming-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="w-full max-w-sm glass-panel rounded-2xl p-6 flex flex-col items-center gap-6 animate-slide-up border-t-2 border-gold-400 shadow-2xl shadow-gold-900/20">
            <div class="w-20 h-20 rounded-full bg-rich-800 border-2 border-gold-400 flex items-center justify-center animate-ring">
                <i data-lucide="phone-incoming" class="w-8 h-8 text-gold-400"></i>
            </div>
            <div class="text-center">
                <p class="text-gold-100 text-sm uppercase tracking-widest font-bold mb-1">Incoming Call</p>
                <h3 id="caller-id-display" class="text-3xl font-serif text-white tracking-wide">Unknown</h3>
                <p class="text-gray-400 text-xs mt-2">Secure Line Request</p>
            </div>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button id="decline-btn" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-red-900/20 border border-red-500/30 text-red-400 active:scale-95 transition-transform">
                    <i data-lucide="phone-off" class="w-6 h-6"></i>
                    <span class="text-xs font-bold uppercase">Decline</span>
                </button>
                <button id="accept-btn" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-green-900/20 border border-green-500/30 text-green-400 active:scale-95 transition-transform">
                    <i data-lucide="phone" class="w-6 h-6"></i>
                    <span class="text-xs font-bold uppercase">Accept</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="px-6 py-4 flex justify-between items-center z-10 glass-panel border-b-0 sticky top-0">
        <div class="flex items-center gap-2">
            <i data-lucide="crown" class="w-5 h-5 text-gold-400"></i>
            <h1 class="text-lg font-serif tracking-wide text-white">LUX<span class="text-gold-400">CALL</span></h1>
        </div>
        <div id="network-status" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]"></div>
    </header>

    <!-- App Container -->
    <main class="flex-grow relative w-full h-full overflow-hidden">
        <!-- Background -->
        <div class="absolute inset-0 z-0 pointer-events-none">
            <div class="absolute top-[-10%] right-[-10%] w-[50vh] h-[50vh] bg-gold-600/10 rounded-full blur-[80px]"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-[50vh] h-[50vh] bg-purple-900/20 rounded-full blur-[80px]"></div>
        </div>

        <!-- LOBBY VIEW -->
        <div id="lobby-view" class="relative z-10 w-full h-full flex flex-col p-6 transition-opacity duration-500 overflow-y-auto custom-scrollbar">
            
            <!-- Name Input Section -->
            <div class="mb-4">
                <label class="text-xs text-gray-500 ml-4 mb-1 block uppercase tracking-wider">Your Name</label>
                <div class="flex gap-2">
                    <input id="name-input" type="text" placeholder="Enter your name" 
                        class="flex-grow bg-rich-800/80 border border-gray-700 text-gold-100 px-6 py-4 rounded-2xl focus:outline-none focus:border-gold-400/50 focus:ring-1 focus:ring-gold-400/50 transition-all placeholder-gray-700">
                    <button id="save-name-btn" class="bg-gold-400/10 text-gold-400 border border-gold-400/30 px-6 rounded-2xl font-bold uppercase text-xs tracking-wider hover:bg-gold-400 hover:text-rich-900 transition-all">
                        Save
                    </button>
                </div>
            </div>

            <!-- My Number Card -->
            <div class="mb-8">
                <p class="text-xs text-gold-300/60 uppercase tracking-widest mb-2 text-center">Your Secure ID</p>
                <div class="glass-panel p-6 rounded-2xl border border-gold-400/30 text-center relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold-400 to-transparent opacity-50"></div>
                    <h2 id="my-id-display" class="text-4xl md:text-5xl font-mono text-white tracking-wider font-light drop-shadow-lg">...</h2>
                    <button id="copy-id-btn" class="mt-4 text-xs text-gold-400 flex items-center justify-center gap-1 mx-auto hover:text-white transition-colors">
                        <i data-lucide="copy" class="w-3 h-3"></i> Copy Number
                    </button>
                </div>
            </div>

            <!-- Dial Pad Section -->
            <div class="pb-8 max-w-md mx-auto w-full">
                <div class="space-y-6">
                    <div class="relative">
                        <label class="text-xs text-gray-500 ml-4 mb-1 block uppercase tracking-wider">Dial Number</label>
                        <div class="relative">
                            <input id="target-id-input" type="number" pattern="[0-9]*" inputmode="numeric" placeholder="000 000 0000" 
                                class="w-full bg-rich-800/80 border border-gray-700 text-gold-100 text-3xl font-mono text-center py-6 rounded-2xl focus:outline-none focus:border-gold-400/50 focus:ring-1 focus:ring-gold-400/50 transition-all placeholder-gray-700">
                        </div>
                    </div>

                    <button id="call-btn" class="w-full bg-gold-400 text-rich-900 font-bold py-5 rounded-2xl shadow-[0_0_20px_rgba(212,175,55,0.2)] active:scale-[0.98] transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:grayscale">
                        <i data-lucide="phone" class="w-6 h-6"></i>
                        <span class="text-lg tracking-wide">INITIATE CALL</span>
                    </button>
                    
                    <p id="status-msg" class="text-center text-xs text-gold-500/80 h-4 font-mono"></p>
                </div>

                <!-- Recent Connections -->
                <div id="recent-calls-container" class="mt-8 hidden">
                    <h3 class="text-xs text-gray-500 ml-4 mb-3 uppercase tracking-wider">Recent Connections</h3>
                    <div id="recent-calls-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                        <!-- Javascript will inject items here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CALL VIEW -->
        <div id="call-view" class="hidden absolute inset-0 z-20 bg-black w-full h-full">
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <div id="waiting-overlay" class="absolute inset-0 bg-rich-900/60 backdrop-blur-sm z-30 flex flex-col items-center justify-center">
                <div class="w-24 h-24 rounded-full border-2 border-gold-400/20 border-t-gold-400 animate-spin mb-6"></div>
                <h3 class="text-2xl font-serif text-white mb-2">Connecting...</h3>
                <p class="text-gold-200/60 text-sm animate-pulse">Establishing Secure Handshake</p>
                <button id="cancel-call-btn" class="mt-8 px-8 py-3 rounded-full bg-red-500/20 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white transition-all text-sm font-bold uppercase tracking-widest">
                    Cancel
                </button>
            </div>

            <!-- Added id for container and changed positioning to inline style in JS, but keeping defaults here -->
            <div id="local-video-container" class="absolute top-6 right-6 w-32 h-48 md:w-48 md:h-72 bg-rich-800 rounded-xl overflow-hidden border-2 border-gold-400/50 shadow-2xl z-40 cursor-move">
                <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
            </div>

            <div class="absolute bottom-10 left-0 right-0 flex justify-center items-center gap-6 z-40 px-6">
                <button id="mute-btn" class="w-14 h-14 rounded-full bg-black/40 backdrop-blur-md border border-white/20 text-white flex items-center justify-center hover:bg-gold-400 hover:text-black hover:border-gold-400 transition-all">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                <button id="hangup-btn" class="w-20 h-20 rounded-full bg-red-600 shadow-lg shadow-red-900/50 text-white flex items-center justify-center hover:bg-red-700 transition-all transform hover:scale-105">
                    <i data-lucide="phone-off" class="w-8 h-8 fill-current"></i>
                </button>
                <button id="camera-btn" class="w-14 h-14 rounded-full bg-black/40 backdrop-blur-md border border-white/20 text-white flex items-center justify-center hover:bg-gold-400 hover:text-black hover:border-gold-400 transition-all">
                    <i data-lucide="video" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import arrayUnion for single-document candidate storage
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                 firebaseConfig = {
                  apiKey: "AIzaSyCVll5mX9iLagImGhSuR7et1LamL0SxK9s",
                  authDomain: "video-calling-214be.firebaseapp.com",
                  projectId: "video-calling-214be",
                  storageBucket: "video-calling-214be.firebasestorage.app",
                  messagingSenderId: "760562664424",
                  appId: "1:760562664424:web:be0361c94619f00421da5d",
                  measurementId: "G-3CZ0BG0K47"
                };
            }
        } catch (e) { console.error("Config Error:", e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let myId = localStorage.getItem('lux_user_id');
        let myName = localStorage.getItem('lux_user_name') || ""; // Load local name

        if (!myId || myId.length !== 10) {
            myId = Math.floor(1000000000 + Math.random() * 9000000000).toString();
            localStorage.setItem('lux_user_id', myId);
        }

        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let currentCallId = null; 
        let isCaller = false;
        let unsubscribeActiveCall = null;
        let unsubscribeIncoming = null;

        // Tracks which candidates we have already processed to prevent duplicates from arrayUnion updates
        let processedCandidates = new Set();

        // --- UI ELEMENTS ---
        const getEl = (id) => document.getElementById(id);
        const ui = {
            lobby: getEl('lobby-view'),
            call: getEl('call-view'),
            myIdDisplay: getEl('my-id-display'),
            targetInput: getEl('target-id-input'),
            callBtn: getEl('call-btn'),
            status: getEl('status-msg'),
            localVideo: getEl('local-video'),
            remoteVideo: getEl('remote-video'),
            localVideoContainer: getEl('local-video-container'), 
            waitingOverlay: getEl('waiting-overlay'),
            incomingModal: getEl('incoming-modal'),
            callerIdDisplay: getEl('caller-id-display'),
            acceptBtn: getEl('accept-btn'),
            declineBtn: getEl('decline-btn'),
            cancelBtn: getEl('cancel-call-btn'),
            hangupBtn: getEl('hangup-btn'),
            muteBtn: getEl('mute-btn'),
            cameraBtn: getEl('camera-btn'),
            networkStatus: getEl('network-status'),
            copyIdBtn: getEl('copy-id-btn'),
            nameInput: getEl('name-input'),
            saveNameBtn: getEl('save-name-btn'),
            recentCallsList: getEl('recent-calls-list'),
            recentCallsContainer: getEl('recent-calls-container')
        };

        // --- RECENT CALLS MANAGER ---
        function loadRecents() {
            try {
                return JSON.parse(localStorage.getItem('lux_recents') || '[]');
            } catch { return []; }
        }

        function saveRecent(id, name, type) {
            if(!id) return;
            const recents = loadRecents();
            // Remove existing entry for this ID to move it to top
            const existingIndex = recents.findIndex(r => r.id === id);
            
            let displayName = name;
            // If we have an existing name and the new one is "Unknown" or empty, keep the old one
            if(existingIndex !== -1) {
                if((!name || name === 'Unknown') && recents[existingIndex].name !== 'Unknown') {
                    displayName = recents[existingIndex].name;
                }
                recents.splice(existingIndex, 1);
            }

            recents.unshift({
                id: id,
                name: displayName || "Unknown",
                lastContact: Date.now(),
                type: type // 'incoming' or 'outgoing'
            });

            // Keep only top 10
            if(recents.length > 10) recents.pop();
            
            localStorage.setItem('lux_recents', JSON.stringify(recents));
            renderRecents();
        }

        function renderRecents() {
            const recents = loadRecents();
            if(recents.length === 0) {
                ui.recentCallsContainer.classList.add('hidden');
                return;
            }
            
            ui.recentCallsContainer.classList.remove('hidden');
            ui.recentCallsList.innerHTML = '';
            
            recents.forEach(contact => {
                const item = document.createElement('div');
                item.className = "glass-panel p-3 rounded-xl flex justify-between items-center group active:bg-white/10 transition-all";
                
                const formattedId = contact.id.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
                const isUnknown = contact.name === 'Unknown';
                
                item.innerHTML = `
                    <div class="cursor-pointer flex-grow" onclick="window.populateAndCall('${contact.id}')">
                        <p class="text-gold-100 font-serif font-bold ${isUnknown ? 'italic text-gray-400' : ''}">${contact.name}</p>
                        <div class="flex items-center gap-2">
                            <span class="text-xs ${contact.type === 'incoming' ? 'text-blue-400' : 'text-green-400'}">
                                ${contact.type === 'incoming' ? '↙' : '↗'}
                            </span>
                            <p class="text-xs text-gray-500 font-mono tracking-widest">${formattedId}</p>
                        </div>
                    </div>
                    <button onclick="window.populateAndCall('${contact.id}')" class="text-gold-400 p-2 rounded-full border border-gold-400/20 hover:bg-gold-400 hover:text-rich-900 transition-colors">
                        <i data-lucide="phone" class="w-4 h-4"></i>
                    </button>
                `;
                ui.recentCallsList.appendChild(item);
            });
            lucide.createIcons();
        }
        
        // Expose global function for click handlers
        window.populateAndCall = (id) => {
            if(ui.targetInput) {
                ui.targetInput.value = id;
                ui.callBtn.click();
            }
        };

        // --- DRAG FUNCTIONALITY ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;
            element.ontouchstart = dragTouchStart;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function dragTouchStart(e) {
                const touch = e.touches[0];
                pos3 = touch.clientX;
                pos4 = touch.clientY;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDragTouch;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                setElementPos();
            }

            function elementDragTouch(e) {
                const touch = e.touches[0];
                pos1 = pos3 - touch.clientX;
                pos2 = pos4 - touch.clientY;
                pos3 = touch.clientX;
                pos4 = touch.clientY;
                setElementPos();
            }

            function setElementPos() {
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight;
                if(newTop < 0) newTop = 0;
                if(newLeft < 0) newLeft = 0;
                if(newTop > maxY) newTop = maxY;
                if(newLeft > maxX) newLeft = maxX;
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
                element.style.right = 'auto';
                element.style.bottom = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }
        
        if(ui.localVideoContainer) makeDraggable(ui.localVideoContainer);

        // --- INITIALIZATION ---
        if (ui.myIdDisplay) ui.myIdDisplay.textContent = myId.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
        if (ui.nameInput && myName) ui.nameInput.value = myName;
        renderRecents(); // Initial Render
        lucide.createIcons();

        // --- AUTH ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error", error);
                if(ui.status) ui.status.textContent = "Auth Error. Refresh.";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if(ui.networkStatus) {
                    ui.networkStatus.classList.remove('bg-red-500', 'shadow-[0_0_8px_rgba(239,68,68,0.5)]');
                    ui.networkStatus.classList.add('bg-green-500', 'shadow-[0_0_8px_rgba(34,197,94,0.5)]');
                }
                if(ui.callBtn) ui.callBtn.disabled = false;
                
                // Fetch saved name from DB on load (Source of Truth)
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', myId);
                getDoc(userDocRef).then(snap => {
                    if(snap.exists()) {
                        const data = snap.data();
                        if(data.name) {
                            myName = data.name;
                            if(ui.nameInput) ui.nameInput.value = myName;
                            localStorage.setItem('lux_user_name', myName);
                        }
                    }
                });

                listenForIncomingCalls(); 
            }
        });

        initAuth();

        // --- SAVE NAME ---
        if(ui.saveNameBtn) {
            ui.saveNameBtn.onclick = async () => {
                const name = ui.nameInput.value.trim();
                if(!name) {
                    ui.status.textContent = "Please enter a name";
                    return;
                }
                
                ui.saveNameBtn.disabled = true;
                ui.saveNameBtn.textContent = "...";
                
                try {
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', myId);
                    await setDoc(userDocRef, { name: name }, { merge: true });
                    
                    myName = name;
                    localStorage.setItem('lux_user_name', name);
                    
                    ui.saveNameBtn.textContent = "Saved";
                    setTimeout(() => {
                        ui.saveNameBtn.disabled = false;
                        ui.saveNameBtn.textContent = "Save";
                    }, 2000);
                } catch(e) {
                    console.error("Error saving name", e);
                    ui.status.textContent = "Error saving name";
                    ui.saveNameBtn.disabled = false;
                    ui.saveNameBtn.textContent = "Save";
                }
            };
        }

        // --- WEBRTC ---
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ],
            iceCandidatePoolSize: 10,
        };

        async function startLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                if(ui.localVideo) ui.localVideo.srcObject = stream;
                remoteStream = new MediaStream();
                if(ui.remoteVideo) ui.remoteVideo.srcObject = remoteStream;
                return true;
            } catch (err) {
                console.error(err);
                if(ui.status) ui.status.textContent = "Error: Camera/Mic required";
                return false;
            }
        }

        function createPeerConnection(isInitiator, callDocRef) {
            pc = new RTCPeerConnection(servers);
            
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            pc.ontrack = event => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            pc.onicecandidate = event => {
                if (event.candidate) {
                    const fieldName = isInitiator ? 'offerCandidates' : 'answerCandidates';
                    updateDoc(callDocRef, {
                        [fieldName]: arrayUnion(event.candidate.toJSON())
                    }).catch(e => console.log("Error sending candidate (safely ignored if doc closed)", e));
                }
            };
            
            return pc;
        }

        // --- LOGIC: LISTEN FOR CALLS ---
        function listenForIncomingCalls() {
            const myCallDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);

            unsubscribeIncoming = onSnapshot(myCallDoc, (snapshot) => {
                const data = snapshot.data();
                
                // 1. Incoming Call
                if (data && data.status === 'calling' && !currentCallId) {
                    // Show Name if available, else ID
                    const callerName = data.callerName || data.callerId || "Unknown";
                    if(ui.callerIdDisplay) {
                        ui.callerIdDisplay.textContent = callerName;
                    }
                    if(ui.incomingModal) {
                        ui.incomingModal.classList.remove('hidden');
                        ui.incomingModal.classList.add('flex');
                    }
                    // Save to recents immediately on ring
                    saveRecent(data.callerId, data.callerName || "Unknown", 'incoming');
                }
                
                // 2. Call Ended remotely
                if ((!data || data.status === 'ended') && currentCallId && !isCaller) {
                   resetCall();
                }
            }, (error) => {
                console.warn("Incoming listener warning:", error);
            });
        }

        // --- LOGIC: MAKE CALL ---
        if(ui.callBtn) {
            ui.callBtn.onclick = async () => {
                const targetId = ui.targetInput.value.replace(/\s/g, '');
                if (targetId.length !== 10) return ui.status.textContent = "Enter 10-digit ID";
                if (targetId === myId) return ui.status.textContent = "Cannot call self";

                ui.callBtn.disabled = true;
                ui.status.textContent = "Dialing...";

                // Try to fetch target name for history
                let targetName = "Unknown";
                try {
                     const targetUserDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId));
                     if(targetUserDoc.exists() && targetUserDoc.data().name) {
                         targetName = targetUserDoc.data().name;
                     }
                } catch(e) {}
                
                // Save to history
                saveRecent(targetId, targetName, 'outgoing');

                if (await startLocalStream()) {
                    isCaller = true;
                    currentCallId = targetId; 
                    processedCandidates.clear(); 
                    
                    ui.lobby.classList.add('hidden');
                    ui.call.classList.remove('hidden');
                    ui.waitingOverlay.classList.remove('hidden');

                    const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', targetId);
                    
                    pc = createPeerConnection(true, callDocRef);

                    const offerDescription = await pc.createOffer();
                    await pc.setLocalDescription(offerDescription);

                    const offer = { sdp: offerDescription.sdp, type: offerDescription.type };

                    try {
                        await setDoc(callDocRef, {
                            callerId: myId,
                            callerName: myName || "Unknown", // Send Name
                            offer: offer,
                            status: 'calling',
                            timestamp: Date.now(),
                            offerCandidates: [],
                            answerCandidates: []
                        });
                    } catch (e) {
                        console.error("SetDoc failed", e);
                        ui.status.textContent = "Connection Error";
                        resetCall();
                        return;
                    }

                    unsubscribeActiveCall = onSnapshot(callDocRef, (snapshot) => {
                        const data = snapshot.data();
                        if (!data) { resetCall(); return; }

                        if (pc && pc.signalingState === 'have-local-offer' && data.answer && data.status === 'connected') {
                            const answerDescription = new RTCSessionDescription(data.answer);
                            pc.setRemoteDescription(answerDescription)
                                .then(() => {
                                    ui.waitingOverlay.classList.add('hidden');
                                })
                                .catch(e => console.error("Error setting remote answer:", e));
                        }

                        if (data.answerCandidates && Array.isArray(data.answerCandidates)) {
                            data.answerCandidates.forEach(candidate => {
                                const candStr = JSON.stringify(candidate);
                                if (!processedCandidates.has(candStr)) {
                                    processedCandidates.add(candStr);
                                    if(pc && pc.remoteDescription) {
                                        pc.addIceCandidate(new RTCIceCandidate(candidate))
                                            .catch(e => console.log("Candidate error (ignored):", e));
                                    }
                                }
                            });
                        }

                        if (data.status === 'ended') resetCall();
                    }, (error) => console.error("Active call listener error:", error));
                }
            };
        }

        // --- LOGIC: ACCEPT CALL ---
        if(ui.acceptBtn) {
            ui.acceptBtn.onclick = async () => {
                ui.incomingModal.classList.add('hidden');
                ui.incomingModal.classList.remove('flex');
                
                if (await startLocalStream()) {
                    isCaller = false;
                    currentCallId = myId; 
                    processedCandidates.clear();

                    ui.lobby.classList.add('hidden');
                    ui.call.classList.remove('hidden');
                    ui.waitingOverlay.classList.add('hidden');

                    const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);
                    
                    pc = createPeerConnection(false, callDocRef);

                    const snapshot = await getDoc(callDocRef);
                    const data = snapshot.data();
                    if(!data) { resetCall(); return; }
                    
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));

                    const answerDescription = await pc.createAnswer();
                    await pc.setLocalDescription(answerDescription);
                    
                    const answer = { type: answerDescription.type, sdp: answerDescription.sdp };

                    await updateDoc(callDocRef, {
                        answer: answer,
                        status: 'connected'
                    });

                    if(data.offerCandidates) {
                        data.offerCandidates.forEach(c => {
                            const str = JSON.stringify(c);
                            if(!processedCandidates.has(str)) {
                                processedCandidates.add(str);
                                pc.addIceCandidate(new RTCIceCandidate(c));
                            }
                        });
                    }

                    unsubscribeActiveCall = onSnapshot(callDocRef, (snapshot) => {
                        const data = snapshot.data();
                        if (!data) return;

                        if (data.offerCandidates && Array.isArray(data.offerCandidates)) {
                            data.offerCandidates.forEach(candidate => {
                                const candStr = JSON.stringify(candidate);
                                if (!processedCandidates.has(candStr)) {
                                    processedCandidates.add(candStr);
                                    if(pc && pc.remoteDescription) {
                                        pc.addIceCandidate(new RTCIceCandidate(candidate));
                                    }
                                }
                            });
                        }
                    }, (error) => console.error("Accept listener error:", error));
                }
            };
        }

        // --- UTILS ---
        async function endCall() {
            if (currentCallId) {
                const docId = isCaller ? currentCallId : myId;
                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', docId);
                try { await deleteDoc(callDoc); } catch(e) {}
            }
            resetCall();
        }

        function resetCall() {
            if (pc) { pc.close(); pc = null; }
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if (unsubscribeActiveCall) { unsubscribeActiveCall(); unsubscribeActiveCall = null; }

            if(ui.incomingModal) {
                ui.incomingModal.classList.add('hidden');
                ui.incomingModal.classList.remove('flex');
            }
            if(ui.call) ui.call.classList.add('hidden');
            if(ui.lobby) {
                ui.lobby.classList.remove('hidden');
                ui.lobby.classList.remove('opacity-0');
            }
            if(ui.callBtn) ui.callBtn.disabled = false;
            if(ui.status) ui.status.textContent = "";
            currentCallId = null;
        }

        if(ui.declineBtn) {
            ui.declineBtn.onclick = async () => {
                 ui.incomingModal.classList.add('hidden');
                 ui.incomingModal.classList.remove('flex');
                 const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', myId);
                 try { await deleteDoc(callDoc); } catch(e) {}
            };
        }

        if(ui.hangupBtn) ui.hangupBtn.onclick = endCall;
        if(ui.cancelBtn) ui.cancelBtn.onclick = endCall;

        if(ui.muteBtn) {
            ui.muteBtn.onclick = () => {
                if(localStream) {
                    const track = localStream.getAudioTracks()[0];
                    if(track) {
                        track.enabled = !track.enabled;
                        ui.muteBtn.innerHTML = track.enabled ? '<i data-lucide="mic" class="w-6 h-6"></i>' : '<i data-lucide="mic-off" class="w-6 h-6 text-red-500"></i>';
                        lucide.createIcons();
                    }
                }
            };
        }

        if(ui.cameraBtn) {
            ui.cameraBtn.onclick = () => {
                if(localStream) {
                    const track = localStream.getVideoTracks()[0];
                    if(track) {
                        track.enabled = !track.enabled;
                        ui.cameraBtn.innerHTML = track.enabled ? '<i data-lucide="video" class="w-6 h-6"></i>' : '<i data-lucide="video-off" class="w-6 h-6 text-red-500"></i>';
                        lucide.createIcons();
                    }
                }
            };
        }

        if (ui.copyIdBtn) {
             ui.copyIdBtn.onclick = () => {
                 navigator.clipboard.writeText(myId).then(() => {
                     const original = ui.copyIdBtn.innerHTML;
                     ui.copyIdBtn.textContent = "Copied!";
                     setTimeout(() => ui.copyIdBtn.innerHTML = original, 1500);
                 });
            }
        }
    </script>
</body>
</html>
